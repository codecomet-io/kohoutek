{"version":3,"file":"entrypoint.js","sourceRoot":"/","sources":["entrypoint.ts"],"names":[],"mappings":"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","sourcesContent":["import {Tracer} from \"./dependencies/ts-core/sentry.js\"\nimport {StdinIngester, BuffIngester} from \"./lib/ts-trace-sdk/ingester.js\";\nimport {ActionInstance, ActionStatus, Pipeline, TasksPool} from \"./lib/ts-trace-sdk/model.js\";\nimport {stdin} from \"node:process\";\nimport {bool, error, nil} from \"codecomet-js/source/buildkit-port/dependencies/golang/mock.js\";\nimport CodeComet from \"codecomet-js/index.js\";\nimport {ReadFromIMPL} from \"codecomet-js/source/buildkit-port/client/llb/marshal.js\";\nimport {Protobuf} from \"codecomet-js/source/utils/protobuf.js\";\nimport {digest} from \"codecomet-js/source/buildkit-port/dependencies/opencontainers/go-digest.js\";\nimport {Types} from \"codecomet-js/source/protobuf/types.js\";\nimport {readFileSync, writeFileSync} from \"fs\";\n\n// Init Sentry\nnew Tracer(\"https://c02314800c4d4be2a32f1d28c4220f3f@o1370052.ingest.sentry.io/6673370\")\n\ntype Meta = {\n    id: string\n    description: string\n    commit: string // \"651a7ef66b7277f7c293dee8aec6e38305b03022\",\n    author: string // \"spacedub\",\n    parent: string // \"c2356d03e4bb824ef898808cf558fc75615beddb\",\n    dirty: bool // true,\n    location: string // \"github.com/codecomet-io/reporter-elastic\",\n}\n\n\n\ntype llbOp = {\n    Op:         Types.Op\n    Digest:     digest.Digest\n    OpMetadata: Types.OpMetadata\n}\n\nfunction ingest(buff: Buffer): [llbOp[], error] {\n    let [def, err] = ReadFromIMPL(buff)\n    if (err != nil)\n        return [nil, err]\n\n    var ops: llbOp[] = []\n    def.Def.forEach(function(dt) {\n        let op = <Types.Op>Protobuf.read(\"Op\", dt)\n        let dgst = digest.FromBytes(dt)\n        let ent = <llbOp>{\n            Op: op,\n            Digest: dgst,\n            OpMetadata: def.Metadata[dgst]\n        }\n        ops.push(ent)\n    })\n    return [ops, nil]\n}\n\nexport default async function Pantry(buff: Buffer, trace: Buffer, meta: string): Promise<Pipeline> {\n    await CodeComet.Bootstrap()\n\n    // Spoof in metadata\n    let metadata : Meta = JSON.parse(meta) as Meta;\n\n    // Retrieve the data model from protobuf first, chain that into the ingester\n    // Suck up the serialized protobuf, spit out semi-acceptable objects\n    let [ops, err] = ingest(buff);\n\n    // Suck up stdin for the logs\n    // new StdinIngester(stdin, function(pl: Pipeline, tsks: TasksPool){\n    let buffIngester = new BuffIngester()\n    let pipeline = buffIngester.ingest(trace)\n//        , function(pl: Pipeline, tsks: TasksPool){\n    // XXX piggyback on metadata\n    pipeline.id = metadata.id\n    pipeline.description = metadata.description\n    pipeline.repository.commit = metadata.commit\n    pipeline.repository.author = metadata.author\n    pipeline.repository.parent = metadata.parent\n    pipeline.repository.dirty = metadata.dirty\n    pipeline.repository.location = metadata.location\n\n            // callback(pipeline, tsks)\n            // console.warn(JSON.stringify(tsks, null, 2))\n            //         ops.forEach(function(op){\n            //             console.warn(op.Digest)\n            //             // OpMetadata\n            //         })\n            // console.warn(JSON.stringify(pipeline, null, 2))\n//        })\n    return pipeline\n}\n\n\nasync function run(protoPath: string, tracePath: string, meta: string, destination: string) {\n    // Retrieve the protobuf definition and the trace file from wherever they are (XHR, file)\n    // Here, just lazily readfilesync them\n    let buff = readFileSync(protoPath)\n    let trace = readFileSync(tracePath)\n\n    // Get the pipeline and the tasks from Pantry\n    let pipeline = await Pantry(buff, trace, meta)\n\n    writeFileSync(destination, JSON.stringify(pipeline, null, 2))\n    // console.warn(JSON.stringify(pipeline, null, 2))\n}\n\nrun(\n    process.argv[2],\n    process.argv[3],\n    process.argv[4],\n    process.argv[5]\n)\n"]}